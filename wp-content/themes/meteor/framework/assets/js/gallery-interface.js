(function(e){function h(t){var n=e(t).attr("href");c.siblings("input:text").val(n),tb_remove()}function v(t){return t=e.trim(t).replace(a,""),t.indexOf(document.WP_HOME_URL)===0&&(u&&(t=document.WP_HOME_URL+"/wp-content/blogs.dir/"+document.WP_MULTISITE_ID+"/"+t.replace(document.WP_HOME_URL+"/","")),t=[(t=t.split(".")).pop(),t.join(".")+("-"+s+"x"+o)].reverse().join(".")),t}function m(e,t,n){typeof n=="undefined"&&(n={});var r=t.data("related");r.thumbData=e;if(n.refreshSort){r.textarea.val(JSON.stringify(e));return}var i=[],s=r.options.width||80,o=r.options.height||80;for(var u,a=r.thumbData.length,f=0;f<a;f++)u=r.thumbData[f],i.push(p.thumb.render({title:u.title&&u.url?u.title+" - "+u.url:u.title||u.url,image:v(u.image),url:u.url,index:f,width:s,height:o}));r.textarea.val(JSON.stringify(e)),r.thumbContainer.html(i.join("\n")),r.thumbContainer.sortable(d).disableSelection(),r.thumbContainer.find("li").data("related",r)}function g(t){if(n)return t.preventDefault();n=!0;var r=this.__self||(this.__self=e(this)),i=r.data("related");i.thumbContainer.sortable("option","disabled",!0),r.hide(),i.gallery.prepend(i.editImage.clear().setContext("add-image")),i.editImage.find("input.image-input").focus(),i.body.keyup(i.keyUp),t.preventDefault()}function y(t){var s=e('<form class="edit-image option" action="#action" method="get">  <p><strong>Title: </strong><input class="title-input" type="text" value="" /></p>  <p><strong>Description: </strong><input class="description-input" type="text" value="" /></p>  <p><strong>Image: </strong> <small style="color: #999;">(must be from the media gallery)</small> <input class="image-input" type="text" value="" /><a class="upload-image-link">Upload Image</a></p>  <p><strong>URL: </strong><input class="url-input" type="text" value="" /></p>   <div class="buttons">    <a style="padding-left: 20px; padding-right: 20px;" class="btn btn-primary exec"></a>    <a style="padding-left: 23px; padding-right: 23px;" class="btn btn-light edit-cancel">Close</a>    <div class="clear"></div>  </div><!-- buttons --></form>'),o=e("#publishing-action input:submit#publish"),u=s.find("input.title-input"),a=s.find("input.description-input"),f=s.find("input.image-input"),l=s.find(".url-input"),c=s.find(".btn.exec"),h=s.find(".btn.edit-cancel");return t.noUrl&&l.parents("p").hide(),t.noTitle&&u.parents("p").hide(),t.showDescription||a.parents("p").hide(),o.click(function(e){n&&c.trigger("click")}),s.data("ui",{titleInput:u,imageInput:f,urlInput:l,execButton:c,cancelButton:h}),s.submit(function(e){e.preventDefault()}),s.find("input:text").keyup(function(e){e.keyCode==13&&(c.trigger("click"),e.preventDefault())}),s.clear=function(){return this.setTitle(""),this.setDescription(""),this.setImage(""),this.setUrl(""),this},s.setTitle=function(e){return u.val(sanitizer.unescapeEntities(e||"")),this},s.setDescription=function(e){return a.val(sanitizer.unescapeEntities(e||"")),this},s.setImage=function(e){return f.val(e),this},s.setUrl=function(e){return l.val(e),this},s.setContext=function(e){var t,n=this.data("related");n.context=e;switch(e){case"add-image":t=" &nbsp;  Add  &nbsp; ";break;case"edit-image":t="Update"}return c.html(t),this},s.getData=function(){return{title:sanitizer.escape(u.val()||""),description:sanitizer.escape(a.val()||""),image:encodeURI(f.val()||""),url:encodeURI(l.val()||"")}},c.click(function(e){var t=s.data("related"),n=s.getData();t.body.unbind("keyup",t.keyUp);if(n.image.length===0)return;switch(t.context){case"add-image":t.thumbData.unshift(n),m(t.thumbData,t.thumbContainer);break;case"edit-image":var r=t.thumbData[t.currentIndex]=s.getData(),o=t.thumbContainer.find("li:eq("+t.currentIndex+") img");r.title&&r.url?o.attr("title",r.title+" - "+r.url):o.attr("title",r.title||r.url);var u=t.options.width||80,a=t.options.height||80;o.attr({src:v(r.image),width:u,height:a}),m(t.thumbData,t.thumbContainer,{refreshSort:!0})}h.trigger("click"),i.trigger("gi:update"),e.preventDefault()}),h.click(function(e){var t=s.data("related");t.editImage.detach(),t.addImageButton.show(),t.thumbContainer.find("> li").css("opacity",1),t.thumbContainer.sortable("option","disabled",!1),t.body.unbind("keyup",t.keyUp),e.preventDefault(),n=r=!1}),s}var t=e(document),n=!1,r=!1,i=t,s=document.GI_THUMB_WIDTH,o=document.GI_THUMB_HEIGHT,u=typeof document.WP_MULTISITE_ID=="number";i.bind("gi:unlock",function(){n=!1});var a=/\?a=[a-z]{1,2}(\s+)?$/,f=/\.(.+)$/,l=window.send_to_editor,c;t.delegate(".gallery-interface a.upload-image-link","click",function(t){var n=this.__self||(this.__self=e(this));c=n,window.send_to_editor=h,tb_show("","media-upload.php?label=chooseThisImage&amp;type=image&amp;TB_iframe=true"),t.preventDefault()}),t.delegate(".gallery-interface ul.thumbs li a","click",function(t){var i=this.__self||(this.__self=e(this).parents("li")),s=i.data("related"),o=i.data("index"),u=s.thumbData[o];r&&s.editImage.data("ui").execButton.trigger("click"),s.thumbContainer.sortable("option","disabled",!0),s.currentIndex=o,s.editImage.setTitle(u.title).setDescription(u.description).setImage(u.image).setUrl(u.url).setContext("edit-image"),i.css("opacity",1).siblings("li").css("opacity",.2),s.addImageButton.hide(),s.gallery.prepend(s.editImage),s.body.keyup(s.keyUp),t.preventDefault(),r=n=!0}),t.delegate(".gallery-interface ul.thumbs li span.delete","click",function(t){if(n)return t.preventDefault();var r=e(this).parents("li"),s=r.data("index"),o=r.data("related"),u=[];for(var a=o.thumbData.length,f=0;f<a;f++)f!==s&&u.push(o.thumbData[f]);r.remove(),m(u,o.thumbContainer),i.trigger("gi:delete"),t.preventDefault()});var p={thumb:Hogan.compile('<li data-index="{{{index}}}">  <a><img title="{{{title}}}" width="{{{width}}}" height="{{{height}}}" src="{{{image}}}" /></a>  <span class="delete">&times;</span></li>')},d={tolerance:"pointer",cancel:"span.delete",update:function(){var t=this.__self,n=t.data("related"),r=[];t.find("> li").each(function(t,i){var s=i.__self||(i.__self=e(i)),o=s.data("index");r[t]=n.thumbData[s.data("index")],s.data("index",t)}),m(r,t,{refreshSort:!0})}};t.ready(function(){e(".gi-load").each(function(t,n){var r=e(n),i=r.data("gi-options");r.galleryInterface(i)})}),jQuery.fn.galleryInterface=function(t){return this.each(function(n,r){typeof t=="undefined"&&(t={});var i,s=e(r).hide();i=e.base64.decode(e.trim(s.val()));try{i=decodeURIComponent(escape(i)),i=i.length===0?[]:JSON.parse(i)}catch(o){s.val(i).show().css("font-family","monaco, monospace"),s.after('<div>\n<p style="color: #da0f0d;"><strong>ERROR:</strong> Unable to parse JSON. The data seems to be malformed. You can fix or remove the code to fix or reset the gallery.</p>\n</div>');return}var u=y(t),a=e('  <div class="gallery-interface">  <a class="btn btn-light add-image">Add Image</a>  <div class="clear"></div>  <ul class="thumbs clearfix"></ul>  </div>'),f={body:e("body"),editImage:u,gallery:a,options:t,textarea:s,thumbData:i};f.keyUp=function(e){e.keyCode==27&&u.data("ui").cancelButton.trigger("click")},a.data("related",f),u.data("related",f);var l=f.addImageButton=a.find(".btn.add-image");l.data("related",f);var c=f.thumbContainer=a.find("ul.thumbs");c.data("related",f),c.get(0).__self=c,m(i,c),l.click(g),s.before(a)}),this}})(jQuery);